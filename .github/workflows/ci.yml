name: CI - Continuous Integration

# è§¦å‘æ¡ä»¶ï¼šå½“æœ‰ä»£ç æ¨é€æˆ–PRæ—¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard
      
      # 4. HTMLä»£ç æ£€æŸ¥
      - name: Lint HTML
        run: |
          htmlhint "*.html" || echo "HTMLæ£€æŸ¥å®Œæˆ"
      
      # 5. CSSä»£ç æ£€æŸ¥
      - name: Lint CSS
        run: |
          npx stylelint "**/*.css" --config-basedir . || echo "CSSæ£€æŸ¥å®Œæˆ"
        continue-on-error: true

  # Job 2: æ„å»ºéªŒè¯
  build:
    name: Build Validation
    runs-on: ubuntu-latest
    needs: lint  # ä¾èµ–lint jobå®Œæˆ
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify project structure
        run: |
          echo "âœ… éªŒè¯é¡¹ç›®ç»“æ„..."
          test -f index.html && echo "âœ“ index.html å­˜åœ¨"
          test -f styles.css && echo "âœ“ styles.css å­˜åœ¨"
          test -f script.js && echo "âœ“ script.js å­˜åœ¨"
          test -d assets && echo "âœ“ assets æ–‡ä»¶å¤¹å­˜åœ¨"
      
      - name: Check file sizes
        run: |
          echo "ğŸ“Š æ£€æŸ¥æ–‡ä»¶å¤§å°..."
          find . -name "*.html" -o -name "*.css" -o -name "*.js" | while read file; do
            size=$(wc -c < "$file")
            echo "$(basename $file): ${size} bytes"
          done

  # Job 3: éƒ¨ç½²é¢„è§ˆï¼ˆå¯é€‰ï¼‰
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create deployment message
        run: |
          echo "ğŸš€ å‡†å¤‡éƒ¨ç½²é¢„è§ˆç¯å¢ƒ..."
          echo "åˆ†æ”¯: ${{ github.head_ref }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "ğŸ“ è¿™é‡Œå¯ä»¥é›†æˆ Netlify, Vercel ç­‰éƒ¨ç½²æœåŠ¡"

  # Job 4: å®‰å…¨æ£€æŸ¥
  security:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for sensitive data
        run: |
          echo "ğŸ”’ æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
          # æ£€æŸ¥æ˜¯å¦æœ‰APIå¯†é’¥ã€å¯†ç ç­‰
          if grep -r "API_KEY\|password\|secret" --include="*.js" --include="*.html" .; then
            echo "âš ï¸  è­¦å‘Š: å‘ç°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯"
            exit 1
          else
            echo "âœ… æœªå‘ç°æ•æ„Ÿä¿¡æ¯"
          fi
